package com.example.exploitsapi

import android.content.DialogInterface
import android.os.Bundle
import android.util.Log
import android.widget.*
import androidx.appcompat.app.AlertDialog
import androidx.appcompat.app.AppCompatActivity
import com.android.volley.Request
import com.android.volley.Response
import com.android.volley.toolbox.JsonObjectRequest
import com.android.volley.toolbox.StringRequest
import com.android.volley.toolbox.Volley
import org.json.JSONObject
import kotlin.system.exitProcess

class MainActivity : AppCompatActivity() {

    lateinit var addUserBtn: Button
    lateinit var viewUserBtn: Button
    lateinit var enterUserName: TextView
    lateinit var chooseUserRole: Spinner

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        addUserBtn = findViewById(R.id.addUserBtnId)
        viewUserBtn = findViewById(R.id.viewUserBtnId)
        enterUserName = findViewById(R.id.userNameId)
        chooseUserRole = findViewById(R.id.spinner)

        ArrayAdapter.createFromResource(this,
            R.array.roles_array,
            android.R.layout.simple_spinner_item).also{ adapter ->
            adapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item)

            chooseUserRole.adapter = adapter
        }
        addUserBtn.setOnClickListener {
            if(enterUserName.text.isNotEmpty()){
                addNewUser()
            }else{
                Toast.makeText(this, "Pls enter your username", Toast.LENGTH_SHORT).show()
            }
        }

        viewUserBtn.setOnClickListener {
            viewNewUser()
        }
    }

    private fun viewNewUser() {

        //val textView = findViewById<TextView>(R.id.text)

        val queue = Volley.newRequestQueue(this)
        var url = "http://192.168.43.252:81//v1/index.php?query=getUser&id=1"

        val jsonRequest = JsonObjectRequest( Request.Method.GET, url, null,
        Response.Listener{ response ->
            val errorResponse = response.getJSONObject("errorResponse")
            
            val dataResponse: Any? = response.get("dataResponse") ?: "No data received"

            val error101 = errorResponse.getString("error") + ": " + errorResponse.getString("message")
            //val response101 = dataResponse.getS

            Toast.makeText(this, error101, Toast.LENGTH_SHORT).show()

            val alertDialog: AlertDialog = AlertDialog.Builder(this).create().apply{
                this.setTitle("User Info")
                this.setMessage(dataResponse.toString())
                //this.setButton(AlertDialog.BUTTON_POSITIVE, "Ok")
                this.setButton(AlertDialog.BUTTON_POSITIVE, "ok") {
                        dialog: DialogInterface, which: Int ->
                    Toast.makeText(this@MainActivity, "Done", Toast.LENGTH_SHORT).show()
                }
                //this.setPositiveButton()
            }

            alertDialog.show()

        },
        Response.ErrorListener {
            Toast.makeText(this, it.message, Toast.LENGTH_SHORT).show()
        })

        queue.add(jsonRequest)

    }

    private fun addNewUser() {

        val userName = enterUserName.text.toString()
        val userRole = chooseUserRole.selectedItem.toString()

        val queue = Volley.newRequestQueue(this)
        val url = "http://192.168.43.252:81//v1/index.php?query=createUser"


        val postUserDataRequest : StringRequest =
            object : StringRequest(Request.Method.POST, url,
            Response.Listener<String> { response ->

                val errorResponse = JSONObject(response).getJSONObject("errorResponse")
                val error101 = errorResponse.getString("error") + ": " + errorResponse.getString("message")

                Toast.makeText(this, error101, Toast.LENGTH_SHORT).show()

                if(!errorResponse.getBoolean("state")){
                    enterUserName.text = ""
                }
            },
            Response.ErrorListener {
                val error101 = it.message

                Toast.makeText(this, error101, Toast.LENGTH_SHORT).show()
            }
            ){
                override fun getParams(): Map<String, String> {
                    val params: MutableMap<String, String> = HashMap()
                    params["name"] = userName
                    params["role"] = userRole
                    return params
                }
            }

// Add the request to the RequestQueue.
        queue.add(postUserDataRequest)
    }

}
